<div ng-include="'views/anr/_risk_sheet.html'" ng-if="sheet_risk"></div>

<div ng-if="risks === undefined" class="md-padding" layout="row" layout-align="center center">
    <md-progress-circular md-indeterminate="true"></md-progress-circular>
</div>

<div ng-show="!sheet_risk">
    <div layout="row" layout-align="space-between center" class="md-padding md-padding-left md-padding-right">
        <span class="md-subhead md-padding-left" translate>{{ risks_total }} risks</span>
        <md-progress-circular md-diameter="20" ng-if="anr_risks_table_loading"></md-progress-circular>

        <md-card ng-if="(instmode == 'anr' || instmode == 'inst') && !sheet_risk">
            <div layout="row" layout-wrap class="md-padding-left md-padding-right">
                <form layout="row" layout-wrap layout-align="center center" class="md-padding-left md-padding-right" ng-submit="updateInstanceRisks ? updateInstanceRisks() : updateAnrRisksTable()">
                    <input type="submit" style="position: absolute; left: -99999px">
                    <span ng-if="instance.asset.type == 1">{{ 'Risk threshold (on max CID)' | translate }}&nbsp;</span>
                    <md-radio-group ng-if="instance.asset.type == 1" ng-model="risks_filters.thresholds" layout="row" class="md-primary">
                        <md-radio-button ng-value="-1" aria-label="G"><div class="tbl-risk-calc anr-scales-demo-block green"></div></md-radio-button>
                        <md-radio-button ng-value="thresholds.thresholds.min" aria-label="O"><div class="tbl-risk-calc anr-scales-demo-block orange"></div></md-radio-button>
                        <md-radio-button ng-value="thresholds.thresholds.max" aria-label="R"><div class="tbl-risk-calc anr-scales-demo-block red"></div></md-radio-button>
                    </md-radio-group>

                    &nbsp;

                    <md-input-container style="margin: 0 0">
                        <label translate>Keywords</label>
                        <input ng-model="risks_filters.keywords">
                    </md-input-container>

                    &nbsp;

                    <md-input-container ng-if="instance.asset.type == 1" style="margin: 0 0; min-width: 120px;">
                        <label translate>Processing type</label>
                        <md-select ng-model="risks_filters.kindOfMeasure">
                            <md-option ng-value="null">{{ 'All (unfiltered)' | translate }}</md-option>
                            <md-option ng-value="5">{{ 'Not processed' | translate }}</md-option>
                            <md-option ng-value="1">{{ 'Reduction' | translate }}</md-option>
                            <md-option ng-value="2">{{ 'Denied' | translate }}</md-option>
                            <md-option ng-value="3">{{ 'Accepted' | translate }}</md-option>
                            <md-option ng-value="4">{{ 'Shared' | translate }}</md-option>
                        </md-select>
                    </md-input-container>

                    <md-button class="md-icon-button" ng-click="updateInstanceRisks ? updateInstanceRisks() : updateAnrRisksTable()"><md-icon>search</md-icon><md-tooltip>{{ 'Filter table' | translate }}</md-tooltip></md-button>
                    <md-button class="md-icon-button" ng-click="resetRisksFilters(); updateInstanceRisks ? updateInstanceRisks() : updateAnrRisksTable()"><md-icon>settings_backup_restore</md-icon><md-tooltip>{{ 'Reset filter' | translate }}</md-tooltip></md-button>

                    <div style="width:1px; background:#EAEAEA;height:48px;margin-left:2px;margin-right:10px;"></div>

                    <md-input-container>
                        <label translate>Sort</label>
                        <md-select ng-model="risks_filters.order">
                            <md-option value="auditOrder" ng-if="instance.asset.type != 1 && instmode == 'inst'">{{ 'Audit order' | translate }}</md-option>
                            <md-option value="instance" ng-if="instance.asset.type == 1 || instmode == 'anr'">{{ 'Instance' | translate }}</md-option>
                            <md-option value="c_impact" ng-if="instance.asset.type == 1 || instmode == 'anr'">{{ 'C Impact' | translate }}</md-option>
                            <md-option value="i_impact" ng-if="instance.asset.type == 1 || instmode == 'anr'">{{ 'I Impact' | translate }}</md-option>
                            <md-option value="d_impact" ng-if="instance.asset.type == 1 || instmode == 'anr'">{{ 'D Impact' | translate }}</md-option>
                            <md-option value="threat">{{ 'Threat' | translate }}</md-option>
                            <md-option value="threatRate">{{ 'Threat probability' | translate }}</md-option>
                            <md-option value="vulnerability">{{ 'Vulnerability' | translate }}</md-option>
                            <md-option value="vulnerabilityRate">{{ 'Vulnerability qualification' | translate }}</md-option>
                            <md-option value="maxRisk">{{ 'MAX risk' | translate }}</md-option>
                            <md-option value="targetRisk">{{ 'Target risk' | translate }}</md-option>
                        </md-select>
                    </md-input-container>

                    <md-input-container>
                        <label translate>Sort direction</label>
                        <md-select ng-model="risks_filters.order_direction">
                            <md-option value="asc">{{ 'Ascending' | translate }}</md-option>
                            <md-option value="desc">{{ 'Descending' | translate }}</md-option>
                        </md-select>
                    </md-input-container>

                    <span flex></span>

                    <md-button ng-if="instmode == 'anr'" ng-click="exportInstanceRisks ? exportInstanceRisks() : exportAnrRisksTable()">
                        <md-icon>save</md-icon>
                        {{ 'Export to CSV' | translate }}
                    </md-button>
                </form>
            </div>
        </md-card>

        <md-select class="no-margin" ng-model="risks_filters.page" md-on-close="updateInstanceRisks ? updateInstanceRisks() : updateAnrRisksTable()" ng-if="risks_total > 0 && (!instance || instance.asset.type == 1)">
            <md-option ng-repeat="i in range(1, ceil(risks_total / 50))" ng-value="i"><span translate>Page {{ i }}</span></md-option>
        </md-select>
    </div>

    <div ng-if="risks && risks.length === 0" class="md-padding">
        <em>{{ 'There are no risks for this instance, or your filters returned no results.' | translate }}</em>
    </div>

    <table editable callback="onRisksTableEdited" class="md-html-table big-border-all" ng-if="risks.length > 0">
        <thead class="big-border-bottom">
        <tr>
            <th rowspan="2"><p translate>Instance</p></th>
            <th colspan="3"><p translate>Impact</p></th>
            <th colspan="2" class="big-border-left"><p translate>Threat</p></th>
            <th colspan="3" class="big-border-left"><p translate>Vulnerability</p></th>
            <th colspan="3" class="big-border-left"><p translate>Current risk</p></th>
            <th rowspan="2"><p translate>Processing</p></th>
            <th rowspan="2"><p translate>Target risk</p></th>
        </tr>
        <tr>
            <th>C</th>
            <th>I</th>
            <th>D</th>
            <th class="big-border-left" translate>Label</th>
            <th translate>Prob.</th>
            <th class="big-border-left" translate>Label</th>
            <th translate>Measures set</th>
            <th translate>Qualif.</th>
            <th class="big-border-left">C</th>
            <th>I</th>
            <th>D</th>
        </tr>
        </thead>

        <tbody>
        <tr ng-repeat="risk in risks" edit-model="risk">
            <td title="{{instanceCache[risk.instance].completePath}}">{{instanceCache[risk.instance][_langField('name')]}}</td>
            <td title="{{ scaleCommCache[1][risk.c_impact] }}" class="txtcenter">{{risk.c_impact|dashnull}}</td>
            <td title="{{ scaleCommCache[2][risk.i_impact] }}" class="txtcenter">{{risk.i_impact|dashnull}}</td>
            <td title="{{ scaleCommCache[3][risk.d_impact] }}" class="txtcenter">{{risk.d_impact|dashnull}}</td>
            <td class="preserve-newlines big-border-left" title="{{risk[_langField('threatDescription')]}}">{{risk[_langField('threatLabel')]}}</td>
            <td edit-field="threatRate" edit-type="number" edit-filter="dashnull" class="txtcenter" title="{{threatCommCache[risk.threatRate]}}"></td>
            <td class="preserve-newlines big-border-left" title="{{risk[_langField('vulnDescription')]}}">{{risk[_langField('vulnLabel')]}}</td>
            <td class="preserve-newlines" edit-field="comment" edit-type="textarea"></td>
            <td edit-field="vulnerabilityRate" edit-type="number" edit-filter="dashnull" class="txtcenter" title="{{vulnsCommCache[risk.vulnerabilityRate]}}"></td>
            <td ng-disabled="!risk.c_risk_enabled" class="tbl-risk-calc big-border-left"
                ng-class="{'green': risk.c_risk > 0 && risk.c_risk <= thresholds.thresholds.min, 'orange': risk.c_risk > thresholds.thresholds.min && risk.c_risk <=thresholds.thresholds.max, 'red': risk.c_risk > thresholds.thresholds.max}">{{ risk.c_risk_enabled ? (risk.c_risk | dashnull) : '' }}</td>
            <td ng-disabled="!risk.i_risk_enabled" class="tbl-risk-calc"
                ng-class="{'green': risk.i_risk > 0 && risk.i_risk <= thresholds.thresholds.min, 'orange': risk.i_risk > thresholds.thresholds.min && risk.i_risk <= thresholds.thresholds.max, 'red': risk.i_risk > thresholds.thresholds.max}">{{ risk.i_risk_enabled ? (risk.i_risk | dashnull) : '' }}</td>
            <td ng-disabled="!risk.d_risk_enabled" class="tbl-risk-calc"
                ng-class="{'green': risk.d_risk > 0 && risk.d_risk <= thresholds.thresholds.min, 'orange': risk.d_risk > thresholds.thresholds.min && risk.d_risk <= thresholds.thresholds.max, 'red': risk.d_risk > thresholds.thresholds.max}">{{ risk.d_risk_enabled ? (risk.d_risk | dashnull) : '' }}</td>
            <td>
                <div layout="row" layout-align="center center">
                    <a class="pointer" title="{{ ('Open risk sheet' | translate) }}" ng-click="openRiskSheet(risk)">
                        <md-icon>open_in_new</md-icon>
                    </a>
                    <span class="green-dot" ng-if="risk.t"></span>
                </div>
            </td>
            <td class="txtcenter tbl-risk-calc"
                ng-class="{'green': risk.target_risk > 0 && risk.target_risk < thresholds.thresholds.min, 'orange': risk.target_risk >= thresholds.thresholds.min && risk.target_risk < thresholds.thresholds.max, 'red': risk.target_risk >= thresholds.thresholds.max}">{{risk.target_risk | dashnull}}</td>
        </tr>
        </tbody>
    </table>

    <div layout="row" layout-align="space-between center">
        <md-button ng-click="createSpecRisk($event)" ng-if="OFFICE_MODE == 'FO'"><md-icon>add</md-icon> {{ 'Create a specific risk' | translate }}</md-button>
        <md-select ng-if="risks_total > 0 && (!instance || instance.asset.type == 1)" ng-model="risks_filters.page" md-on-close="updateInstanceRisks ? updateInstanceRisks() : updateAnrRisksTable()">
            <md-option ng-repeat="i in range(1, ceil(risks_total / 50))" ng-value="i"><span translate>Page {{ i }}</span></md-option>
        </md-select>
    </div>
</div>
