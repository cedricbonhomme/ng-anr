<md-tab label="{{ 'OP risks table' | translate }}">
    <div layout-gt-lg="row" layout="column" layout-align="center center" ng-if="(instmode == 'anr' || instmode == 'inst') && !opsheet_risk">
        <md-card>
            <md-card-content layout="column" layout-align="center center">
                <form ng-submit="updateInstanceRisks ? updateInstanceRisks() : updateAnrRisksTable()">
                    <input type="submit" style="position: absolute; left: -99999px">
                    <div layout="row" layout-align="center center">
                        {{ 'Risk threshold (on max NET risk)' | translate }}&nbsp;
                        <md-radio-group ng-model="risks_op_filters.thresholds" layout="row" class="md-primary">
                            <md-radio-button ng-value="-1" aria-label="G"><div class="tbl-risk-calc anr-scales-demo-block green"></div></md-radio-button>
                            <md-radio-button ng-value="thresholds.thresholds.min" aria-label="O"><div class="tbl-risk-calc anr-scales-demo-block orange"></div></md-radio-button>
                            <md-radio-button ng-value="thresholds.thresholds.max" aria-label="R"><div class="tbl-risk-calc anr-scales-demo-block red"></div></md-radio-button>
                        </md-radio-group>

                        &nbsp;

                        <md-input-container style="margin: 0 0">
                            <label translate>Keywords</label>
                            <input ng-model="risks_op_filters.keywords">
                        </md-input-container>

                        &nbsp;

                        <md-input-container style="margin: 0 0; min-width: 120px;">
                            <label translate>Processing type</label>
                            <md-select ng-model="risks_op_filters.kindOfMeasure">
                                <md-option ng-value="null">{{ 'All (unfiltered)' | translate }}</md-option>
                                <md-option ng-value="5">{{ 'Not processed' | translate }}</md-option>
                                <md-option ng-value="1">{{ 'Reduction' | translate }}</md-option>
                                <md-option ng-value="2">{{ 'Denied' | translate }}</md-option>
                                <md-option ng-value="3">{{ 'Accepted' | translate }}</md-option>
                                <md-option ng-value="4">{{ 'Shared' | translate }}</md-option>
                            </md-select>
                        </md-input-container>

                        <md-button class="md-icon-button" ng-click="updateInstanceRisksOp ? updateInstanceRisksOp() : updateAnrRisksOpTable()"><md-icon>search</md-icon><md-tooltip>{{ 'Filter table' | translate }}</md-tooltip></md-button>
                        <md-button class="md-icon-button" ng-click="resetRisksOpFilters(); updateInstanceRisksOp ? updateInstanceRisksOp() : updateAnrRisksOpTable()"><md-icon>settings_backup_restore</md-icon><md-tooltip>{{ 'Reset filter' | translate }}</md-tooltip></md-button>
                    </div>

                    <div layout="row" layout-align="end center">

                        <md-button ng-if="instmode == 'anr'" ng-click="exportInstanceRisksOp ? exportInstanceRisksOp() : exportAnrRisksOpTable()">
                            <md-icon>save</md-icon>
                            {{ 'Export to CSV' | translate }}
                        </md-button>
                    </div>
                </form>
            </md-card-content>
        </md-card>
    </div>

    <div layout="row" layout-align="start center">
        <p class="md-title md-padding" ng-if="!opsheet_risk" translate>{{ oprisks_total }} operational risk(s)</p>
        <span flex></span>
        <md-select ng-model="risks_op_filters.page" md-on-close="updateInstanceRisksOp ? updateInstanceRisksOp() : updateAnrRisksOpTable()" ng-if="oprisks_total > 0">
            <md-option ng-repeat="i in range(1, ceil(oprisks_total / 50))" ng-value="i"><span translate>Page {{ i }}</span></md-option>
        </md-select>
    </div>


    <div ng-include="'views/anr/_oprisk_sheet.html'" ng-if="opsheet_risk"></div>

    <div ng-if="!oprisks || !oprisks.length" class="md-padding">
        <em ng-if="instmode == 'inst' ">{{ 'There are no operational risks for this instance, or the filters gave no results.' | translate }}</em>
        <em ng-if="instmode == 'anr' ">{{ 'There are no operational risks for this risk analysis, or the filters gave no results.' | translate }}</em>
        <em ng-if="instmode == 'obj' ">{{ 'There are no operational risks for this object.' | translate }}</em>
    </div>

    <table class="md-html-table inputs-as-number" ng-if="!opsheet_risk && oprisks.length > 0" editable callback="changeRiskOp">
        <thead>
        <tr>
            <th rowspan="3" translate>Risk description</th>
            <th ng-if="model.showRolfBrut" colspan="7" translate>RAW</th>
            <th colspan="7" translate>NET</th>
            <th rowspan="3" translate>Observation</th>
            <th rowspan="3">T</th>
            <th rowspan="3" translate>Target risk</th>
            <th ng-if=" instmode != 'obj' " rowspan="3" translate>Actions</th>
        </tr>

        <tr>
            <th rowspan="2" translate ng-if="model.showRolfBrut && (instmode != 'obj' || mode == 'anr') ">Prob.</th>
            <th colspan="5" translate ng-if="model.showRolfBrut && (instmode != 'obj' || mode == 'anr') ">Impact</th>
            <th rowspan="2" translate ng-if="model.showRolfBrut && (instmode != 'obj' || mode == 'anr') ">Calculated risk</th>

            <th rowspan="2" translate>Prob.</th>
            <th colspan="5" translate>Impact</th>
            <th rowspan="2" translate>Calculated risk</th>
        </tr>

        <tr>
            <th ng-if="model.showRolfBrut && (instmode != 'obj' || mode == 'anr') ">R</th>
            <th ng-if="model.showRolfBrut && (instmode != 'obj' || mode == 'anr') ">O</th>
            <th ng-if="model.showRolfBrut && (instmode != 'obj' || mode == 'anr') ">L</th>
            <th ng-if="model.showRolfBrut && (instmode != 'obj' || mode == 'anr') ">F</th>
            <th ng-if="model.showRolfBrut && (instmode != 'obj' || mode == 'anr') ">P</th>

            <th>R</th>
            <th>O</th>
            <th>L</th>
            <th>F</th>
            <th>P</th>
        </tr>
        </thead>

        <tbody>
        <tr ng-repeat="risk in oprisks" edit-model="risk">
            <td class="preserve-newlines">{{ risk[_langField('description')] }}</td>
            <td ng-if="model.showRolfBrut && (instmode != 'obj' || mode == 'anr' || instmode == 'inst')" edit-filter="dashnull" edit-field="brutProb" title="{{threatCommCache[risk.brutProb]}}"></td>
            <td ng-if="model.showRolfBrut && (instmode != 'obj' || mode == 'anr' || instmode == 'inst')" edit-filter="dashnull" edit-field="brutR" title="{{scaleCommCache[4][risk.brutR]}}"></td>
            <td ng-if="model.showRolfBrut && (instmode != 'obj' || mode == 'anr' || instmode == 'inst')" edit-filter="dashnull" edit-field="brutO" title="{{scaleCommCache[5][risk.brutO]}}"></td>
            <td ng-if="model.showRolfBrut && (instmode != 'obj' || mode == 'anr' || instmode == 'inst')" edit-filter="dashnull" edit-field="brutL" title="{{scaleCommCache[6][risk.brutL]}}"></td>
            <td ng-if="model.showRolfBrut && (instmode != 'obj' || mode == 'anr' || instmode == 'inst')" edit-filter="dashnull" edit-field="brutF" title="{{scaleCommCache[7][risk.brutF]}}"></td>
            <td ng-if="model.showRolfBrut && (instmode != 'obj' || mode == 'anr' || instmode == 'inst')" edit-filter="dashnull" edit-field="brutP" title="{{scaleCommCache[8][risk.brutP]}}"></td>
            <td ng-if="model.showRolfBrut && (instmode != 'obj' || mode == 'anr' || instmode == 'inst')" class="tbl-risk-calc"
                ng-class="{'green': risk.cacheBrutRisk > 0 && risk.cacheBrutRisk < thresholds.rolf_thresholds.min, 'orange': risk.cacheBrutRisk >= thresholds.rolf_thresholds.min && risk.cacheBrutRisk < thresholds.rolf_thresholds.max, 'red': risk.cacheBrutRisk >= thresholds.rolf_thresholds.max}">{{risk.cacheBrutRisk|dashnull}}</td>
            <td class="small" ng-if="instmode == 'anr' || instmode == 'inst'" edit-field="netProb" edit-filter="dashnull" title="threatCommCache[risk.netProb]"></td>
            <td class="small" ng-if="instmode == 'obj'">-</td>
            <td class="small" ng-if="instmode == 'anr' || instmode == 'inst'" edit-field="netR" edit-filter="dashnull" title="{{scaleCommCache[4][risk.netR]}}"></td>
            <td class="small" ng-if="instmode == 'obj'">-</td>
            <td class="small" ng-if="instmode == 'anr' || instmode == 'inst'" edit-field="netO" edit-filter="dashnull" title="{{scaleCommCache[5][risk.netO]}}"></td>
            <td class="small" ng-if="instmode == 'obj'">-</td>
            <td class="small" ng-if="instmode == 'anr' || instmode == 'inst'" edit-field="netL" edit-filter="dashnull" title="{{scaleCommCache[6][risk.netL]}}"></td>
            <td class="small" ng-if="instmode == 'obj'">-</td>
            <td class="small" ng-if="instmode == 'anr' || instmode == 'inst'" edit-field="netF" edit-filter="dashnull" title="{{scaleCommCache[7][risk.netF]}}"></td>
            <td class="small" ng-if="instmode == 'obj'">-</td>
            <td class="small" ng-if="instmode == 'anr' || instmode == 'inst'" edit-field="netP" edit-filter="dashnull" title="{{scaleCommCache[8][risk.netP]}}"></td>
            <td class="small" ng-if="instmode == 'obj'">-</td>
            <td class="tbl-risk-calc" ng-class="{'green': risk.cacheNetRisk > 0 && risk.cacheNetRisk < thresholds.rolf_thresholds.min, 'orange': risk.cacheNetRisk >= thresholds.rolf_thresholds.min && risk.cacheNetRisk < thresholds.rolf_thresholds.max, 'red': risk.cacheNetRisk >= thresholds.rolf_thresholds.max}">{{ risk.cacheNetRisk|dashnull }}</td>
            <td class="preserve-newlines" ng-if="instmode == 'anr' || instmode == 'inst'" edit-field="comment" edit-type="textarea"></td>
            <td class="small" ng-if="instmode == 'obj'">-</td>
            <td class="txtcenter"><div style="display:inline-block" class="green-dot" ng-if="risk.t"></div></td>
            <td class="tbl-risk-calc" ng-class="{'green': risk.cacheTargetedRisk > 0 && risk.cacheTargetedRisk < thresholds.rolf_thresholds.min, 'orange': risk.cacheTargetedRisk >= thresholds.rolf_thresholds.min && risk.cacheTargetedRisk < thresholds.rolf_thresholds.max, 'red': risk.cacheTargetedRisk >= thresholds.rolf_thresholds.max}">{{ risk.cacheTargetedRisk|dashnull }}</td>
            <td class="txtcenter" ng-if=" instmode != 'obj' ">
                <a href="javascript:;" ng-click="openOpRiskSheet(risk)" title="{{ 'Open risk sheet' | translate }} - {{instmode}}">
                    <md-icon>open_in_new</md-icon>
                </a>
            </td>
        </tr>
        </tbody>
    </table>

    <div layout="row" layout-align="end center" ng-if="oprisks_total > 0">
        <md-select ng-model="risks_op_filters.page" md-on-close="updateInstanceRisks ? updateInstanceRisks() : updateAnrRisksTable()">
            <md-option ng-repeat="i in range(1, ceil(oprisks_total / 50))" ng-value="i"><span translate>Page {{ i }}</span></md-option>
        </md-select>
    </div>
</md-tab>
