<div class="md-padding-left md-padding-right" layout="column" ng-controller="AnrRopaCtrl" ng-if="tabRopaDisplayed">
    <p class="md-title md-padding-left" translate>Records of processing activities</p>
    <md-tabs md-dynamic-height="true" md-selected="recordTabSelected" ng-if="!(updatingRecords)" >
        <md-button class="md-icon-button md-primary" ng-if="!isAnrReadOnly" ng-disabled="selectingRecord || updatingRecords" ng-click="createNewRecord($event)">
            <md-tooltip md-direction="left">
                {{ 'Add a record' | translate }}
            </md-tooltip>
            <md-icon class="md-icon-button md-primary">add_to_photos</md-icon>
        </md-button>

        <md-tab ng-repeat="currentRecord in records.items.records" label="{{ _langField(currentRecord,'label')}}"
            md-on-select="selectRecord(currentRecord.id, $index)">

            <div layout="row" layout-align="end center" class="md-padding-double" style="height:40px">
                <md-menu>
                    <md-button class="md-icon-button" ng-click="$mdMenu.open()">
                        <md-icon class="md-warn">file_download</md-icon><md-tooltip>{{ 'Export' | translate }}</md-tooltip>
                    </md-button>
                    <md-menu-content>
                        <md-menu-item>
                            <md-button ng-click="jsonExport()">.json</md-button>
                        </md-menu-item>
                        <md-menu-item>
                            <md-button ng-click="export()">.csv</md-button>
                        </md-menu-item>
                    </md-menu-content>
                </md-menu>
                <md-button class="md-icon-button md-primary" ng-if="!isAnrReadOnly && records.items.records.length > 0" ng-click="editRecord($event,currentRecord.id)">
                    <md-tooltip md-direction="left">
                        {{ 'Edit record' | translate }}
                    </md-tooltip>
                    <md-icon>edit</md-icon>
                </md-button>
                <md-button class="md-icon-button md-warn" ng-if="!isAnrReadOnly && records.items.records.length > 0" ng-click="deleteRecord($event, currentRecord.id)">
                    <md-tooltip md-direction="left">
                        {{ 'Delete record' | translate }}
                    </md-tooltip>
                    <md-icon>delete</md-icon>
                </md-button>
            </div>
            <p class="md-title md-padding-left"> <b> {{ _langField(currentRecord,'label')}} </b> </p>
            <p class="md-subhead md-padding-left" translate>Controller</p>
            <md-table-container flex>
                <table md-table>
                    <tbody md-body>
                        <tr md-row>
                            <td md-cell> <b> {{ 'Name: ' | translate }} </b> </td>
                            <td md-cell> {{ currentRecord.controller.label }} </td>
                            <td md-cell> <b> {{ 'Contact: ' | translate }} </b> </td>
                            <td md-cell> {{ currentRecord.controller.contact }} </td>
                        </tr>
                        <tr md-row>
                            <td md-cell> <b> {{ "Representative: " | translate }} </b> </td>
                            <td md-cell> {{ currentRecord.representative}} </td>
                            <td md-cell> <b> {{ "Data Protection Officer: " | translate }} </b> </td>
                            <td md-cell> {{ currentRecord.dpo }} </td>
                        </tr>
                        <tr md-row>
                            <td md-cell>  <b> {{ "Purposes of the processing: " | translate }} </b> </td>
                            <td md-cell> {{ currentRecord.purposes }} </td>
                            <td md-cell>  <b> {{ "Categories of data subjects: " | translate }} </b> </td>
                            <td md-cell> {{ currentRecord.description }} </td>
                        </tr>
                        <tr md-row>
                            <td md-cell> <b> {{ "Time limits for erasure: " | translate }} </b> </td>
                            <td md-cell> {{  currentRecord.erasure.toLocaleDateString() }} </td>
                            <td md-cell> <b> {{ "Technical and organisational security measures: " | translate }} </b> </td>
                            <td md-cell> {{ currentRecord.secMeasures }} </td>
                        </tr>
                        <tr md-row ng-if="currentRecord.idThirdCountry">
                            <td md-cell> <b> {{ 'Third country organisation Id' | translate }} </b> </td>
                            <td md-cell> {{ currentRecord.idThirdCountry }} </td>
                            <td md-cell> <b> {{ 'Third country data protection officer' | translate }} </b> </td>
                            <td md-cell> {{ currentRecord.dpoThirdCountry }} </td>
                        </tr>
                        <tr md-row ng-if="currentRecord.jointControllers.length>0 " >
                            <td md-cell > <b> <span translate> Joint Controllers: </b> </span> </td>
                            <td md-cell colspan="3">
                                <md-table-container flex>
                                    <table md-table>
                                        <tbody md-body>
                                            <tr md-row>
                                                <th md-cell width="30%"> <b> <span translate>Name</span> </b> </th>
                                                <th md-cell width="70%"> <b> <span translate>Contact</span> </b> </th>
                                            </tr>
                                            <tr md-row ng-repeat="jc in currentRecord.jointControllers">
                                                <td md-cell>{{ jc.label }}</td>
                                                <td md-cell>{{ jc.contact }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </md-table-container>
                            </td>
                        </tr>
                        <tr md-row ng-if="currentRecord.recipients.length > 0" >
                            <td md-cell rowspan="{{currentRecord.recipients.length}}"> <b> <span translate>Recipient Categories </b> </span> </td>
                            <td colspan="3"> {{currentRecord.recipients[0]['label'] }} </td>
                        </tr>
                        <tr ng-repeat="recipient in currentRecord.recipients.slice(1)" md-row>
                            <td colspan="3"> {{recipient['label'] }} </td>
                        </tr>
                  </tbody>
              </table>
          </md-table-container>
          <p class="md-subhead md-padding-left" ng-if="currentRecord.processors.length > 0" translate>Processors</p>
          <md-tabs md-dynamic-height="true" md-selected="processorTabSelected">
              <md-tab ng-repeat="processor in currentRecord.processors" label="{{processor.label}}"
                  md-on-select="selectProcessor(processor.id)">
                  <div layout="row" layout-align="end center" class="md-padding-double" style="height:40px">
                      <md-button class="md-icon-button md-primary" ng-if="!isAnrReadOnly" ng-click="editProcessor($event,processor.id)">
                          <md-tooltip md-direction="left">
                              {{ 'Edit processor' | translate }}
                          </md-tooltip>
                          <md-icon>edit</md-icon>
                      </md-button>
                      <md-button class="md-icon-button md-primary" ng-if="!isAnrReadOnly" ng-click="unbindProcessor($event,currentRecord.id,processor.id)">
                          <md-tooltip md-direction="left">
                              {{ 'Detach processor' | translate }}
                          </md-tooltip>
                          <md-icon>content_cut</md-icon>
                      </md-button>
                  </div>
                  <md-table-container flex>
                      <table md-table>
                          <tbody md-body>
                              <tr md-row>
                                  <td md-cell width=20% > <b> {{ 'Name' | translate }} </b> </td>
                                  <td md-cell> {{ processor.label }} </td>
                              </tr>
                              <tr md-row>
                                  <td md-cell> <b> {{ "Contact" | translate }} </b> </td>
                                  <td md-cell> {{ processor.contact }} </td>
                              </tr>

                              <tr md-row ng-if="processor.controllers.length>0">
                                  <td md-cell > <b> <span translate> Controllers on behalf this processor is acting on </span> </td>
                                  <td md-cell>
                                      <md-table-container flex>
                                          <table md-table>
                                              <tbody md-body>
                                                  <tr md-row>
                                                      <th md-cell width="30%"> <b> <span translate>Name</span> </b></th>
                                                      <th md-cell width="70%"> <b> <span translate>Contact</span> </b></th>
                                                  </tr>
                                                  <tr md-row ng-repeat="bc in processor.controllers">
                                                      <td md-cell>{{ bc.label }}</td>
                                                      <td md-cell>{{ bc.contact }}</td>
                                                  </tr>
                                              </tbody>
                                          </table>
                                      </md-table-container>
                                  </td>
                              </tr>
                              <tr md-row ng-if="processor.idThirdCountry">
                                  <td md-cell> <b> {{ 'Third country or international organisation Id' | translate }} </b> </td>
                                  <td md-cell> {{ processor.idThirdCountry }} </td>
                              </tr>
                              <tr md-row ng-if="processor.dpoThirdCountry">
                                  <td md-cell> <b> {{ 'Third country data protection officer' | translate }} </b> </td>
                                  <td md-cell> {{ processor.dpoThirdCountry }} </td>
                              </tr>
                              <tr md-row ng-if="processor.secMeasures">
                                  <td md-cell> <b> {{ "Technical and organisational security measures" | translate }} </b> </td>
                                  <td md-cell> {{ processor.secMeasures }} </td>
                              </tr>
                        </tbody>
                    </table>
                </md-table-container>
            </md-tab>
        </md-tabs>
      </md-tab>
    </md-tabs>
</div>
